---
layout: post
title:  "Dubbo架构简述"
date:   2017-11-16
excerpt: "简述dubbo的架构流程"
tag:
- dubbo
comments: true
---

## 全局入口--spring schema handler

spring handler：```com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler```，定义了不同元素的解析器与映射的类。比如**dubbo:reference**对应**ReferenceBean**，**dubbo:service**对应**ServiceBean**。

## provider侧

* 读取spring配置，dubbo会将spring xml中的**dubbo:service**元素通过预先定义好的解析器封装成一个**ServiceBean**，这是一个service的入口。
* **ServiceBean**实现了spring的**ApplicationListener**接口，用来监听spring上下文事件。Dubbo响应了**ContextRefreshedEvent**事件，在上下文刷新之后执行**导出provider**动作。
* 执行导出操作，需要两个信息： 
    1. 通信协议信息，用来指定consumer和provider间的通信方式以及信息。
    2. 注册中心信息，用来往对应的注册中心注册provider url。
* ```com.alibaba.dubbo.config.ServiceConfig#doExportUrls```生成**registry URL**以及**provider URL**，并将**provider URL**作为**registry URL**的export参数绑定。根据**registry URL**的协议**registry://**拿到对应的**RegistryProtocol**并调用其**export**方法。
* ```com.alibaba.dubbo.registry.integration.RegistryProtocol#export```主要完成两件事情：
    1. 作为provider，使用定义好的通信协议来暴露服务，如dubbo，http，rmi等。
        * 从**registry URL**的export参数来获取**provider URL**。
        * 通过**provider URL**的协议来获取其对应的协议处理类并调用**export**方法。
    2. 使用**registry URL**中的registry参数作为注册中心协议替换原来的**registry://**协议
        * 通过新的**registry URL**的协议头，拿到相应的```com.alibaba.dubbo.registry.Registry```实例并调用其```com.alibaba.dubbo.registry.RegistryService#register```方法，比如向zookeeper新建临时节点。

* 以上，就是provider侧的执行流程简述。

## consumer侧

* 同样的，dubbo会将**dubbo:reference**封装成一个**ReferenceBean**，但与provider不同，consumer实现了````org.springframework.beans.factory.FactoryBean```接口，初始化的流程推迟到了调用```org.springframework.beans.factory.FactoryBean#getObject```时。

